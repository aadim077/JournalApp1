@page "/timeline"
@inject JournalService JournalService
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Journal Timeline</MudText>

    <MudGrid>
        @if (_entries != null && _entries.Any())
        {
            @foreach (var entry in _entries.OrderByDescending(e => e.Date))
            {
                <MudItem xs="12">
                    <MudCard Elevation="2" Class="mb-4">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@entry.Title</MudText>
                                <MudText Typo="Typo.caption">@entry.Date.ToLongDateString()</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" OnClick="@(() => EditEntry(entry.Id))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteEntry(entry.Id))" />
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText Typo="Typo.body1" Class="text-truncate" Style="max-height: 100px; overflow: hidden;">
                                @entry.Content
                            </MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Text">@entry.WordCount words</MudChip>
                            @if (entry.CategoryId.HasValue)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Secondary">Category ID: @entry.CategoryId</MudChip>
                            }
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }

            <MudItem xs="12" Class="d-flex justify-center mt-4">
                <MudPagination SelectedChanged="PageChanged" Count="_totalPages" />
            </MudItem>
        }
        else if (_isLoaded)
        {
            <MudItem xs="12">
                <MudAlert Severity="Severity.Info">No entries found. Start journaling today!</MudAlert>
            </MudItem>
        }
        else
        {
            <MudItem xs="12">
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            </MudItem>
        }
    </MudGrid>
</MudContainer>

@code {
    private List<JournalEntry> _entries = new();
    private bool _isLoaded = false;
    private int _pageSize = 10;
    private int _totalPages = 1;
    private int _currentPage = 1;

    protected override async Task OnInitializedAsync()
    {
        if (AuthService.CurrentUser == null)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        await LoadEntries();
    }

    private async Task LoadEntries()
    {
        var allEntries = await JournalService.GetAllEntriesAsync();
        _entries = allEntries.ToList(); 
        
        _totalPages = (int)Math.Ceiling((double)_entries.Count / _pageSize);
        _entries = _entries.Skip((_currentPage - 1) * _pageSize).Take(_pageSize).ToList();
        _isLoaded = true;
    }

    private async Task PageChanged(int page)
    {
        _currentPage = page;
        await LoadEntries();
    }

    private void EditEntry(int entryId)
    {
        NavigationManager.NavigateTo($"/editor/{entryId}");
    }

    private async Task DeleteEntry(int entryId)
    {
        var result = await JournalService.DeleteEntryAsync(entryId);
        if (result.Success)
        {
            Snackbar.Add("Entry deleted", Severity.Success);
            await LoadEntries();
        }
        else Snackbar.Add(result.Message, Severity.Error);
    }
}
