@page "/login"
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">
    <MudPaper Elevation="4" Class="pa-8">
        <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">Login</MudText>
        <MudTextField @bind-Value="_username" Label="Username" Variant="Variant.Outlined" Class="mt-4" />
        <MudTextField @bind-Value="_password" Label="Password" Variant="Variant.Outlined" InputType="InputType.Password" Class="mt-4" />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Class="mt-6" OnClick="ProcessLogin">Login</MudButton>
        <MudText Align="Align.Center" Class="mt-4">
            Don't have an account? <MudLink Href="/register">Register</MudLink>
        </MudText>
    </MudPaper>
</MudContainer>

@code {
    private string _username = "";
    private string _password = "";

    private async Task ProcessLogin()
    {
        if (string.IsNullOrWhiteSpace(_username) || string.IsNullOrWhiteSpace(_password))
        {
            Snackbar.Add("Please enter username and password", Severity.Error);
            return;
        }

        var result = await AuthService.LoginAsync(_username, _password);
        if (result.Success)
        {
            // Standard login successful, now check PIN
            var user = AuthService.CurrentUser;
            bool isSetup = string.IsNullOrEmpty(user?.PinHash);

            var parameters = new DialogParameters { ["IsSetupMode"] = isSetup };
            var options = new DialogOptions { CloseOnEscapeKey = false, BackdropClick = false };
            
            var dialog = DialogService.Show<PinDialog>(isSetup ? "Setup Secure PIN" : "Verify PIN", parameters, options);
            var dialogResult = await dialog.Result;

            if (!dialogResult.Canceled && dialogResult.Data is bool success && success)
            {
                Snackbar.Add("Access granted!", Severity.Success);
                NavigationManager.NavigateTo("/");
            }
            else
            {
                AuthService.Logout(); // PIN failed or canceled, forced logout
                Snackbar.Add("Security verification failed.", Severity.Error);
            }
        }
        else
        {
            Snackbar.Add("Invalid username or password", Severity.Error);
        }
    }
}
